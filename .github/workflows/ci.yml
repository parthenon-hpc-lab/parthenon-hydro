
name: github-linux

on: [push, pull_request]

# Cancel "duplicated" workflows triggered by pushes to internal
# branches with associated PRs.
concurrency:
  group: ${{ github.ref }}-${{ github.head_ref }}-github-linux
  cancel-in-progress: true

jobs:
  test:
    runs-on: self-hosted
    container:
      image: registry.gitlab.com/pgrete/parthenon/cuda11.3-mpi-hdf5
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'true'
      - name: huhu
        run: |
          [ $(grep project CMakeLists.txt  | wc -l) -eq 0 ]
          [ $(grep intddfdfdd CMakeLists.txt  | wc -l) -eq 0 ]

  build-host:
    continue-on-error: true
    strategy:
      matrix:
        cxx: ['g++', 'clang++-13']
        cmake_build_type: ['Release', 'Debug']
        device: ['cuda', 'host']
        parallel: ['serial', 'mpi']
        exclude:
          # Remove builds that are used during testing stage
          - cxx: g++
            device: host
            cmake_build_type: Release
    runs-on: ubuntu-latest
    container:
      image: registry.gitlab.com/pgrete/parthenon/cuda11.4.2-mpi-hdf5
    env:
      CMAKE_GENERATOR: Ninja
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'true'
      - name: CMake
        run: |
          cmake -B builddir \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_BUILD_TYPE=${{ matrix.cmake_build_type }} \
            -DMACHINE_CFG=${PWD}/external/parthenon/cmake/machinecfg/GitHubActions.cmake \
            -DMACHINE_VARIANT=${{ matrix.device }}_${{ matrix.parallel }}
      - name: Build
        run: |
          cmake --build builddir --parallel 2
  test-host:
    continue-on-error: true
    strategy:
      matrix:
        parallel: ['serial', 'mpi']
    runs-on: self-hosted
    container:
      image: registry.gitlab.com/pgrete/parthenon/cuda11.3-mpi-hdf5
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'true'
      - name: CMake
        run: |
          cmake -B builddir \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_BUILD_TYPE=Release \
            -DMACHINE_CFG=${PWD}/external/parthenon/cmake/machinecfg/GitHubActions.cmake \
            -DMACHINE_VARIANT=host_${{ matrix.parallel }} \
            -DNUM_MPI_PROC_TESTING=2
      - name: Build
        run: |
          cmake --build builddir --parallel 5
          cd builddir
          ctest --output-on-failure
  test-device:
    continue-on-error: true
    strategy:
      matrix:
        parallel: ['serial', 'mpi']
    runs-on: self-hosted
    container:
      image: registry.gitlab.com/pgrete/parthenon/cuda11.3-mpi-hdf5
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'true'
      - name: CMake
        run: |
          cmake -B builddir \
            -DCMAKE_BUILD_TYPE=Release \
            -DMACHINE_CFG=${PWD}/cmake/GitHubActions.cmake \
            -DMACHINE_VARIANT=cuda_${{ matrix.parallel }}
      - name: Build
        run: |
          cmake --build builddir --parallel 5
          cd builddir
          #ctest --output-on-failure -LE 'performance|regression'
          export OMPI_MCA_mpi_common_cuda_event_max=1000
          /opt/openmpi/bin/mpiexec -n 2 --allow-run-as-root /__w/parthenon-hydro/parthenon-hydro/builddir/bin/parthenon-hydro -i /__w/parthenon-hydro/parthenon-hydro/inputs/linear_wave3d.in parthenon/mesh/nx1=32 parthenon/meshblock/nx1=16 parthenon/mesh/nx2=16 parthenon/meshblock/nx2=16 parthenon/mesh/nx3=16 parthenon/meshblock/nx3=16 parthenon/time/integrator=rk2 --kokkos-num-devices=1
          ctest --output-on-failure
          ctest -R regression_mpi_test:output_hdf5
          nsys profile --delay=5 --duration=5 --stats=true -s none -t cuda example/advection/advection-example \
            -i ../tst/regression/test_suites/advection_performance/parthinput.advection_performance \
            parthenon/mesh/nx1=128 parthenon/mesh/nx2=128  parthenon/mesh/nx3=128 \
            parthenon/meshblock/nx1=64 parthenon/meshblock/nx2=64 parthenon/meshblock/nx3=64 \
            parthenon/sparse/enable_sparse=false parthenon/time/nlim=2000 parthenon/time/tlim=2 2>&1 | tee profile.txt
          test $(grep HtoD profile.txt |wc -l) == 0
          test $(grep DtoH profile.txt |wc -l) == 0

